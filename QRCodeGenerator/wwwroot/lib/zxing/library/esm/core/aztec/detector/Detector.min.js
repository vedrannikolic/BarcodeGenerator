/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/@zxing/library@0.21.0/esm/core/aztec/detector/Detector.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import ResultPoint from"../../ResultPoint";import AztecDetectorResult from"../AztecDetectorResult";import MathUtils from"../../common/detector/MathUtils";import WhiteRectangleDetector from"../../common/detector/WhiteRectangleDetector";import GenericGF from"../../common/reedsolomon/GenericGF";import ReedSolomonDecoder from"../../common/reedsolomon/ReedSolomonDecoder";import NotFoundException from"../../NotFoundException";import GridSamplerInstance from"../../common/GridSamplerInstance";import Integer from"../../util/Integer";var Point=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.toResultPoint=function(){return new ResultPoint(this.getX(),this.getY())},t.prototype.getX=function(){return this.x},t.prototype.getY=function(){return this.y},t}();export{Point};var Detector=function(){function t(t){this.EXPECTED_CORNER_BITS=new Int32Array([3808,476,2107,1799]),this.image=t}return t.prototype.detect=function(){return this.detectMirror(!1)},t.prototype.detectMirror=function(t){var e=this.getMatrixCenter(),i=this.getBullsEyeCorners(e);if(t){var n=i[0];i[0]=i[2],i[2]=n}this.extractParameters(i);var r=this.sampleGrid(this.image,i[this.shift%4],i[(this.shift+1)%4],i[(this.shift+2)%4],i[(this.shift+3)%4]),o=this.getMatrixCornerPoints(i);return new AztecDetectorResult(r,o,this.compact,this.nbDataBlocks,this.nbLayers)},t.prototype.extractParameters=function(t){if(!(this.isValidPoint(t[0])&&this.isValidPoint(t[1])&&this.isValidPoint(t[2])&&this.isValidPoint(t[3])))throw new NotFoundException;var e=2*this.nbCenterLayers,i=new Int32Array([this.sampleLine(t[0],t[1],e),this.sampleLine(t[1],t[2],e),this.sampleLine(t[2],t[3],e),this.sampleLine(t[3],t[0],e)]);this.shift=this.getRotation(i,e);for(var n=0,r=0;r<4;r++){var o=i[(this.shift+r)%4];this.compact?(n<<=7,n+=o>>1&127):(n<<=10,n+=(o>>2&992)+(o>>1&31))}var s=this.getCorrectedParameterData(n,this.compact);this.compact?(this.nbLayers=1+(s>>6),this.nbDataBlocks=1+(63&s)):(this.nbLayers=1+(s>>11),this.nbDataBlocks=1+(2047&s))},t.prototype.getRotation=function(t,e){var i=0;t.forEach((function(t,n,r){i=(i<<3)+((t>>e-2<<1)+(1&t))})),i=((1&i)<<11)+(i>>1);for(var n=0;n<4;n++)if(Integer.bitCount(i^this.EXPECTED_CORNER_BITS[n])<=2)return n;throw new NotFoundException},t.prototype.getCorrectedParameterData=function(t,e){var i,n;e?(i=7,n=2):(i=10,n=4);for(var r=i-n,o=new Int32Array(i),s=i-1;s>=0;--s)o[s]=15&t,t>>=4;try{new ReedSolomonDecoder(GenericGF.AZTEC_PARAM).decode(o,r)}catch(t){throw new NotFoundException}var a=0;for(s=0;s<n;s++)a=(a<<4)+o[s];return a},t.prototype.getBullsEyeCorners=function(t){var e=t,i=t,n=t,r=t,o=!0;for(this.nbCenterLayers=1;this.nbCenterLayers<9;this.nbCenterLayers++){var s=this.getFirstDifferent(e,o,1,-1),a=this.getFirstDifferent(i,o,1,1),g=this.getFirstDifferent(n,o,-1,1),h=this.getFirstDifferent(r,o,-1,-1);if(this.nbCenterLayers>2){var c=this.distancePoint(h,s)*this.nbCenterLayers/(this.distancePoint(r,e)*(this.nbCenterLayers+2));if(c<.75||c>1.25||!this.isWhiteOrBlackRectangle(s,a,g,h))break}e=s,i=a,n=g,r=h,o=!o}if(5!==this.nbCenterLayers&&7!==this.nbCenterLayers)throw new NotFoundException;this.compact=5===this.nbCenterLayers;var u=new ResultPoint(e.getX()+.5,e.getY()-.5),l=new ResultPoint(i.getX()+.5,i.getY()+.5),f=new ResultPoint(n.getX()-.5,n.getY()+.5),p=new ResultPoint(r.getX()-.5,r.getY()-.5);return this.expandSquare([u,l,f,p],2*this.nbCenterLayers-3,2*this.nbCenterLayers)},t.prototype.getMatrixCenter=function(){var t,e,i,n;try{t=(g=new WhiteRectangleDetector(this.image).detect())[0],e=g[1],i=g[2],n=g[3]}catch(s){var r=this.image.getWidth()/2,o=this.image.getHeight()/2;t=this.getFirstDifferent(new Point(r+7,o-7),!1,1,-1).toResultPoint(),e=this.getFirstDifferent(new Point(r+7,o+7),!1,1,1).toResultPoint(),i=this.getFirstDifferent(new Point(r-7,o+7),!1,-1,1).toResultPoint(),n=this.getFirstDifferent(new Point(r-7,o-7),!1,-1,-1).toResultPoint()}var s=MathUtils.round((t.getX()+n.getX()+e.getX()+i.getX())/4),a=MathUtils.round((t.getY()+n.getY()+e.getY()+i.getY())/4);try{var g;t=(g=new WhiteRectangleDetector(this.image,15,s,a).detect())[0],e=g[1],i=g[2],n=g[3]}catch(r){t=this.getFirstDifferent(new Point(s+7,a-7),!1,1,-1).toResultPoint(),e=this.getFirstDifferent(new Point(s+7,a+7),!1,1,1).toResultPoint(),i=this.getFirstDifferent(new Point(s-7,a+7),!1,-1,1).toResultPoint(),n=this.getFirstDifferent(new Point(s-7,a-7),!1,-1,-1).toResultPoint()}return s=MathUtils.round((t.getX()+n.getX()+e.getX()+i.getX())/4),a=MathUtils.round((t.getY()+n.getY()+e.getY()+i.getY())/4),new Point(s,a)},t.prototype.getMatrixCornerPoints=function(t){return this.expandSquare(t,2*this.nbCenterLayers,this.getDimension())},t.prototype.sampleGrid=function(t,e,i,n,r){var o=GridSamplerInstance.getInstance(),s=this.getDimension(),a=s/2-this.nbCenterLayers,g=s/2+this.nbCenterLayers;return o.sampleGrid(t,s,s,a,a,g,a,g,g,a,g,e.getX(),e.getY(),i.getX(),i.getY(),n.getX(),n.getY(),r.getX(),r.getY())},t.prototype.sampleLine=function(t,e,i){for(var n=0,r=this.distanceResultPoint(t,e),o=r/i,s=t.getX(),a=t.getY(),g=o*(e.getX()-t.getX())/r,h=o*(e.getY()-t.getY())/r,c=0;c<i;c++)this.image.get(MathUtils.round(s+c*g),MathUtils.round(a+c*h))&&(n|=1<<i-c-1);return n},t.prototype.isWhiteOrBlackRectangle=function(t,e,i,n){t=new Point(t.getX()-3,t.getY()+3),e=new Point(e.getX()-3,e.getY()-3),i=new Point(i.getX()+3,i.getY()-3),n=new Point(n.getX()+3,n.getY()+3);var r=this.getColor(n,t);if(0===r)return!1;var o=this.getColor(t,e);return o===r&&((o=this.getColor(e,i))===r&&(o=this.getColor(i,n))===r)},t.prototype.getColor=function(t,e){for(var i=this.distancePoint(t,e),n=(e.getX()-t.getX())/i,r=(e.getY()-t.getY())/i,o=0,s=t.getX(),a=t.getY(),g=this.image.get(t.getX(),t.getY()),h=Math.ceil(i),c=0;c<h;c++)s+=n,a+=r,this.image.get(MathUtils.round(s),MathUtils.round(a))!==g&&o++;var u=o/i;return u>.1&&u<.9?0:u<=.1===g?1:-1},t.prototype.getFirstDifferent=function(t,e,i,n){for(var r=t.getX()+i,o=t.getY()+n;this.isValid(r,o)&&this.image.get(r,o)===e;)r+=i,o+=n;for(r-=i,o-=n;this.isValid(r,o)&&this.image.get(r,o)===e;)r+=i;for(r-=i;this.isValid(r,o)&&this.image.get(r,o)===e;)o+=n;return new Point(r,o-=n)},t.prototype.expandSquare=function(t,e,i){var n=i/(2*e),r=t[0].getX()-t[2].getX(),o=t[0].getY()-t[2].getY(),s=(t[0].getX()+t[2].getX())/2,a=(t[0].getY()+t[2].getY())/2,g=new ResultPoint(s+n*r,a+n*o),h=new ResultPoint(s-n*r,a-n*o);return r=t[1].getX()-t[3].getX(),o=t[1].getY()-t[3].getY(),s=(t[1].getX()+t[3].getX())/2,a=(t[1].getY()+t[3].getY())/2,[g,new ResultPoint(s+n*r,a+n*o),h,new ResultPoint(s-n*r,a-n*o)]},t.prototype.isValid=function(t,e){return t>=0&&t<this.image.getWidth()&&e>0&&e<this.image.getHeight()},t.prototype.isValidPoint=function(t){var e=MathUtils.round(t.getX()),i=MathUtils.round(t.getY());return this.isValid(e,i)},t.prototype.distancePoint=function(t,e){return MathUtils.distance(t.getX(),t.getY(),e.getX(),e.getY())},t.prototype.distanceResultPoint=function(t,e){return MathUtils.distance(t.getX(),t.getY(),e.getX(),e.getY())},t.prototype.getDimension=function(){return this.compact?4*this.nbLayers+11:this.nbLayers<=4?4*this.nbLayers+15:4*this.nbLayers+2*(Integer.truncDivision(this.nbLayers-4,8)+1)+15},t}();export default Detector;
//# sourceMappingURL=/sm/35d1eaee17c42c7b6ad98e0e782c2ef12d5bbbf9a3920ee2c03c41080f439658.map