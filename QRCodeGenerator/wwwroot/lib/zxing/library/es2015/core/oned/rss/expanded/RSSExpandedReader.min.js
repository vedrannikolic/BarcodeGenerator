/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/@zxing/library@0.21.0/es2015/core/oned/rss/expanded/RSSExpandedReader.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import BarcodeFormat from"../../../BarcodeFormat";import MathUtils from"../../../common/detector/MathUtils";import NotFoundException from"../../../NotFoundException";import Result from"../../../Result";import System from"../../../util/System";import AbstractRSSReader from"../../rss/AbstractRSSReader";import DataCharacter from"../../rss/DataCharacter";import FinderPattern from"../../rss/FinderPattern";import RSSUtils from"../../rss/RSSUtils";import BitArrayBuilder from"./BitArrayBuilder";import{createDecoder}from"./decoders/AbstractExpandedDecoderComplement";import ExpandedPair from"./ExpandedPair";import ExpandedRow from"./ExpandedRow";export default class RSSExpandedReader extends AbstractRSSReader{constructor(){super(...arguments),this.pairs=new Array(RSSExpandedReader.MAX_PAIRS),this.rows=new Array,this.startEnd=[2]}decodeRow(e,t,r){this.pairs.length=0,this.startFromEven=!1;try{return RSSExpandedReader.constructResult(this.decodeRow2pairs(e,t))}catch(e){}return this.pairs.length=0,this.startFromEven=!0,RSSExpandedReader.constructResult(this.decodeRow2pairs(e,t))}reset(){this.pairs.length=0,this.rows.length=0}decodeRow2pairs(e,t){let r,d=!1;for(;!d;)try{this.pairs.push(this.retrieveNextPair(t,this.pairs,e))}catch(e){if(e instanceof NotFoundException){if(!this.pairs.length)throw new NotFoundException;d=!0}}if(this.checkChecksum())return this.pairs;if(r=!!this.rows.length,this.storeRow(e,!1),r){let e=this.checkRowsBoolean(!1);if(null!=e)return e;if(e=this.checkRowsBoolean(!0),null!=e)return e}throw new NotFoundException}checkRowsBoolean(e){if(this.rows.length>25)return this.rows.length=0,null;this.pairs.length=0,e&&(this.rows=this.rows.reverse());let t=null;try{t=this.checkRows(new Array,0)}catch(e){console.log(e)}return e&&(this.rows=this.rows.reverse()),t}checkRows(e,t){for(let r=t;r<this.rows.length;r++){let t=this.rows[r];this.pairs.length=0;for(let t of e)this.pairs.push(t.getPairs());if(this.pairs.push(t.getPairs()),!RSSExpandedReader.isValidSequence(this.pairs))continue;if(this.checkChecksum())return this.pairs;let d=new Array(e);d.push(t);try{return this.checkRows(d,r+1)}catch(e){console.log(e)}}throw new NotFoundException}static isValidSequence(e){for(let t of RSSExpandedReader.FINDER_PATTERN_SEQUENCES){if(e.length>t.length)continue;let r=!0;for(let d=0;d<e.length;d++)if(e[d].getFinderPattern().getValue()!==t[d]){r=!1;break}if(r)return!0}return!1}storeRow(e,t){let r=0,d=!1,a=!1;for(;r<this.rows.length;){let t=this.rows[r];if(t.getRowNumber()>e){a=t.isEquivalent(this.pairs);break}d=t.isEquivalent(this.pairs),r++}a||d||RSSExpandedReader.isPartialRow(this.pairs,this.rows)||(this.rows.push(r,new ExpandedRow(this.pairs,e,t)),this.removePartialRows(this.pairs,this.rows))}removePartialRows(e,t){for(let r of t){if(r.getPairs().length===e.length)continue;let t=!0;for(let d of r.getPairs()){let r=!1;for(let t of e)if(ExpandedPair.equals(d,t)){r=!0;break}r||(t=!1)}}}static isPartialRow(e,t){for(let r of t){let t=!0;for(let d of e){let e=!1;for(let t of r.getPairs())if(d.equals(t)){e=!0;break}if(!e){t=!1;break}}if(t)return!0}return!1}getRows(){return this.rows}static constructResult(e){let t=BitArrayBuilder.buildBitArray(e),r=createDecoder(t).parseInformation(),d=e[0].getFinderPattern().getResultPoints(),a=e[e.length-1].getFinderPattern().getResultPoints(),n=[d[0],d[1],a[0],a[1]];return new Result(r,null,null,n,BarcodeFormat.RSS_EXPANDED,null)}checkChecksum(){let e=this.pairs.get(0),t=e.getLeftChar(),r=e.getRightChar();if(null===r)return!1;let d=r.getChecksumPortion(),a=2;for(let e=1;e<this.pairs.size();++e){let t=this.pairs.get(e);d+=t.getLeftChar().getChecksumPortion(),a++;let r=t.getRightChar();null!=r&&(d+=r.getChecksumPortion(),a++)}return d%=211,211*(a-4)+d===t.getValue()}static getNextSecondBar(e,t){let r;return e.get(t)?(r=e.getNextUnset(t),r=e.getNextSet(r)):(r=e.getNextSet(t),r=e.getNextUnset(r)),r}retrieveNextPair(e,t,r){let d,a=t.length%2==0;this.startFromEven&&(a=!a);let n=!0,R=-1;do{this.findNextPair(e,t,R),d=this.parseFoundFinderPattern(e,r,a),null===d?R=RSSExpandedReader.getNextSecondBar(e,this.startEnd[0]):n=!1}while(n);let i,s=this.decodeDataCharacter(e,d,a,!0);if(!this.isEmptyPair(t)&&t[t.length-1].mustBeLast())throw new NotFoundException;try{i=this.decodeDataCharacter(e,d,a,!1)}catch(e){i=null,console.log(e)}return new ExpandedPair(s,i,d,!0)}isEmptyPair(e){return 0===e.length}findNextPair(e,t,r){let d=this.getDecodeFinderCounters();d[0]=0,d[1]=0,d[2]=0,d[3]=0;let a,n=e.getSize();if(r>=0)a=r;else if(this.isEmptyPair(t))a=0;else{a=t[t.length-1].getFinderPattern().getStartEnd()[1]}let R=t.length%2!=0;this.startFromEven&&(R=!R);let i=!1;for(;a<n&&(i=!e.get(a),i);)a++;let s=0,o=a;for(let t=a;t<n;t++)if(e.get(t)!==i)d[s]++;else{if(3===s){if(R&&RSSExpandedReader.reverseCounters(d),RSSExpandedReader.isFinderPattern(d))return this.startEnd[0]=o,void(this.startEnd[1]=t);R&&RSSExpandedReader.reverseCounters(d),o+=d[0]+d[1],d[0]=d[2],d[1]=d[3],d[2]=0,d[3]=0,s--}else s++;d[s]=1,i=!i}throw new NotFoundException}static reverseCounters(e){let t=e.length;for(let r=0;r<t/2;++r){let d=e[r];e[r]=e[t-r-1],e[t-r-1]=d}}parseFoundFinderPattern(e,t,r){let d,a,n;if(r){let t=this.startEnd[0]-1;for(;t>=0&&!e.get(t);)t--;t++,d=this.startEnd[0]-t,a=t,n=this.startEnd[1]}else a=this.startEnd[0],n=e.getNextUnset(this.startEnd[1]+1),d=n-this.startEnd[1];let R,i=this.getDecodeFinderCounters();System.arraycopy(i,0,i,1,i.length-1),i[0]=d;try{R=this.parseFinderValue(i,RSSExpandedReader.FINDER_PATTERNS)}catch(e){return null}return new FinderPattern(R,[a,n],a,n,t)}decodeDataCharacter(e,t,r,d){let a=this.getDataCharacterCounters();for(let e=0;e<a.length;e++)a[e]=0;if(d)RSSExpandedReader.recordPatternInReverse(e,t.getStartEnd()[0],a);else{RSSExpandedReader.recordPattern(e,t.getStartEnd()[1],a);for(let e=0,t=a.length-1;e<t;e++,t--){let r=a[e];a[e]=a[t],a[t]=r}}let n=MathUtils.sum(new Int32Array(a))/17,R=(t.getStartEnd()[1]-t.getStartEnd()[0])/15;if(Math.abs(n-R)/R>.3)throw new NotFoundException;let i=this.getOddCounts(),s=this.getEvenCounts(),o=this.getOddRoundingErrors(),E=this.getEvenRoundingErrors();for(let e=0;e<a.length;e++){let t=1*a[e]/n,r=t+.5;if(r<1){if(t<.3)throw new NotFoundException;r=1}else if(r>8){if(t>8.7)throw new NotFoundException;r=8}let d=e/2;0==(1&e)?(i[d]=r,o[d]=t-r):(s[d]=r,E[d]=t-r)}this.adjustOddEvenCounts(17);let S=4*t.getValue()+(r?0:2)+(d?0:1)-1,p=0,l=0;for(let e=i.length-1;e>=0;e--){if(RSSExpandedReader.isNotA1left(t,r,d)){let t=RSSExpandedReader.WEIGHTS[S][2*e];l+=i[e]*t}p+=i[e]}let h=0;for(let e=s.length-1;e>=0;e--)if(RSSExpandedReader.isNotA1left(t,r,d)){let t=RSSExpandedReader.WEIGHTS[S][2*e+1];h+=s[e]*t}let _=l+h;if(0!=(1&p)||p>13||p<4)throw new NotFoundException;let x=(13-p)/2,u=RSSExpandedReader.SYMBOL_WIDEST[x],F=9-u,A=RSSUtils.getRSSvalue(i,u,!0),c=RSSUtils.getRSSvalue(s,F,!1),N=RSSExpandedReader.EVEN_TOTAL_SUBSET[x],P=RSSExpandedReader.GSUM[x];return new DataCharacter(A*N+c+P,_)}static isNotA1left(e,t,r){return!(0===e.getValue()&&t&&r)}adjustOddEvenCounts(e){let t=MathUtils.sum(new Int32Array(this.getOddCounts())),r=MathUtils.sum(new Int32Array(this.getEvenCounts())),d=!1,a=!1;t>13?a=!0:t<4&&(d=!0);let n=!1,R=!1;r>13?R=!0:r<4&&(n=!0);let i=t+r-e,s=1==(1&t),o=0==(1&r);if(1===i)if(s){if(o)throw new NotFoundException;a=!0}else{if(!o)throw new NotFoundException;R=!0}else if(-1===i)if(s){if(o)throw new NotFoundException;d=!0}else{if(!o)throw new NotFoundException;n=!0}else{if(0!==i)throw new NotFoundException;if(s){if(!o)throw new NotFoundException;t<r?(d=!0,R=!0):(a=!0,n=!0)}else if(o)throw new NotFoundException}if(d){if(a)throw new NotFoundException;RSSExpandedReader.increment(this.getOddCounts(),this.getOddRoundingErrors())}if(a&&RSSExpandedReader.decrement(this.getOddCounts(),this.getOddRoundingErrors()),n){if(R)throw new NotFoundException;RSSExpandedReader.increment(this.getEvenCounts(),this.getOddRoundingErrors())}R&&RSSExpandedReader.decrement(this.getEvenCounts(),this.getEvenRoundingErrors())}}RSSExpandedReader.SYMBOL_WIDEST=[7,5,4,3,1],RSSExpandedReader.EVEN_TOTAL_SUBSET=[4,20,52,104,204],RSSExpandedReader.GSUM=[0,348,1388,2948,3988],RSSExpandedReader.FINDER_PATTERNS=[Int32Array.from([1,8,4,1]),Int32Array.from([3,6,4,1]),Int32Array.from([3,4,6,1]),Int32Array.from([3,2,8,1]),Int32Array.from([2,6,5,1]),Int32Array.from([2,2,9,1])],RSSExpandedReader.WEIGHTS=[[1,3,9,27,81,32,96,77],[20,60,180,118,143,7,21,63],[189,145,13,39,117,140,209,205],[193,157,49,147,19,57,171,91],[62,186,136,197,169,85,44,132],[185,133,188,142,4,12,36,108],[113,128,173,97,80,29,87,50],[150,28,84,41,123,158,52,156],[46,138,203,187,139,206,196,166],[76,17,51,153,37,111,122,155],[43,129,176,106,107,110,119,146],[16,48,144,10,30,90,59,177],[109,116,137,200,178,112,125,164],[70,210,208,202,184,130,179,115],[134,191,151,31,93,68,204,190],[148,22,66,198,172,94,71,2],[6,18,54,162,64,192,154,40],[120,149,25,75,14,42,126,167],[79,26,78,23,69,207,199,175],[103,98,83,38,114,131,182,124],[161,61,183,127,170,88,53,159],[55,165,73,8,24,72,5,15],[45,135,194,160,58,174,100,89]],RSSExpandedReader.FINDER_PAT_A=0,RSSExpandedReader.FINDER_PAT_B=1,RSSExpandedReader.FINDER_PAT_C=2,RSSExpandedReader.FINDER_PAT_D=3,RSSExpandedReader.FINDER_PAT_E=4,RSSExpandedReader.FINDER_PAT_F=5,RSSExpandedReader.FINDER_PATTERN_SEQUENCES=[[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_A],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_B],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_D],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_C],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_F],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_F,RSSExpandedReader.FINDER_PAT_F],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_D],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_E],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_F,RSSExpandedReader.FINDER_PAT_F],[RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_A,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_B,RSSExpandedReader.FINDER_PAT_C,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_D,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_E,RSSExpandedReader.FINDER_PAT_F,RSSExpandedReader.FINDER_PAT_F]],RSSExpandedReader.MAX_PAIRS=11;
//# sourceMappingURL=/sm/20c26cb41c74d4dac6c347bc816acfe557d32973de2b4f672cc1423a7c7e4823.map