/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/@zxing/library@0.21.0/es2015/core/pdf417/decoder/PDF417ScanningDecoder.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import ChecksumException from"../../ChecksumException";import FormatException from"../../FormatException";import NotFoundException from"../../NotFoundException";import MathUtils from"../../common/detector/MathUtils";import PDF417Common from"../PDF417Common";import ErrorCorrection from"./ec/ErrorCorrection";import BoundingBox from"./BoundingBox";import DetectionResultRowIndicatorColumn from"./DetectionResultRowIndicatorColumn";import DetectionResult from"./DetectionResult";import DetectionResultColumn from"./DetectionResultColumn";import Codeword from"./Codeword";import BarcodeValue from"./BarcodeValue";import PDF417CodewordDecoder from"./PDF417CodewordDecoder";import DecodedBitStreamParser from"./DecodedBitStreamParser";import Formatter from"../../util/Formatter";export default class PDF417ScanningDecoder{constructor(){}static decode(e,t,o,n,r,l,c){let u,a=new BoundingBox(e,t,o,n,r),d=null,i=null;for(let o=!0;;o=!1){if(null!=t&&(d=PDF417ScanningDecoder.getRowIndicatorColumn(e,a,t,!0,l,c)),null!=n&&(i=PDF417ScanningDecoder.getRowIndicatorColumn(e,a,n,!1,l,c)),u=PDF417ScanningDecoder.merge(d,i),null==u)throw NotFoundException.getNotFoundInstance();let r=u.getBoundingBox();if(!o||null==r||!(r.getMinY()<a.getMinY()||r.getMaxY()>a.getMaxY()))break;a=r}u.setBoundingBox(a);let g=u.getBarcodeColumnCount()+1;u.setDetectionResultColumn(0,d),u.setDetectionResultColumn(g,i);let C=null!=d;for(let t=1;t<=g;t++){let o,n=C?t:g-t;if(void 0!==u.getDetectionResultColumn(n))continue;o=0===n||n===g?new DetectionResultRowIndicatorColumn(a,0===n):new DetectionResultColumn(a),u.setDetectionResultColumn(n,o);let r=-1,d=r;for(let t=a.getMinY();t<=a.getMaxY();t++){if(r=PDF417ScanningDecoder.getStartColumn(u,n,t,C),r<0||r>a.getMaxX()){if(-1===d)continue;r=d}let i=PDF417ScanningDecoder.detectCodeword(e,a.getMinX(),a.getMaxX(),C,r,t,l,c);null!=i&&(o.setCodeword(t,i),d=r,l=Math.min(l,i.getWidth()),c=Math.max(c,i.getWidth()))}}return PDF417ScanningDecoder.createDecoderResult(u)}static merge(e,t){if(null==e&&null==t)return null;let o=PDF417ScanningDecoder.getBarcodeMetadata(e,t);if(null==o)return null;let n=BoundingBox.merge(PDF417ScanningDecoder.adjustBoundingBox(e),PDF417ScanningDecoder.adjustBoundingBox(t));return new DetectionResult(o,n)}static adjustBoundingBox(e){if(null==e)return null;let t=e.getRowHeights();if(null==t)return null;let o=PDF417ScanningDecoder.getMax(t),n=0;for(let e of t)if(n+=o-e,e>0)break;let r=e.getCodewords();for(let e=0;n>0&&null==r[e];e++)n--;let l=0;for(let e=t.length-1;e>=0&&(l+=o-t[e],!(t[e]>0));e--);for(let e=r.length-1;l>0&&null==r[e];e--)l--;return e.getBoundingBox().addMissingRows(n,l,e.isLeft())}static getMax(e){let t=-1;for(let o of e)t=Math.max(t,o);return t}static getBarcodeMetadata(e,t){let o,n;return null==e||null==(o=e.getBarcodeMetadata())?null==t?null:t.getBarcodeMetadata():null==t||null==(n=t.getBarcodeMetadata())?o:o.getColumnCount()!==n.getColumnCount()&&o.getErrorCorrectionLevel()!==n.getErrorCorrectionLevel()&&o.getRowCount()!==n.getRowCount()?null:o}static getRowIndicatorColumn(e,t,o,n,r,l){let c=new DetectionResultRowIndicatorColumn(t,n);for(let u=0;u<2;u++){let a=0===u?1:-1,d=Math.trunc(Math.trunc(o.getX()));for(let u=Math.trunc(Math.trunc(o.getY()));u<=t.getMaxY()&&u>=t.getMinY();u+=a){let t=PDF417ScanningDecoder.detectCodeword(e,0,e.getWidth(),n,d,u,r,l);null!=t&&(c.setCodeword(u,t),d=n?t.getStartX():t.getEndX())}}return c}static adjustCodewordCount(e,t){let o=t[0][1],n=o.getValue(),r=e.getBarcodeColumnCount()*e.getBarcodeRowCount()-PDF417ScanningDecoder.getNumberOfECCodeWords(e.getBarcodeECLevel());if(0===n.length){if(r<1||r>PDF417Common.MAX_CODEWORDS_IN_BARCODE)throw NotFoundException.getNotFoundInstance();o.setValue(r)}else n[0]!==r&&o.setValue(r)}static createDecoderResult(e){let t=PDF417ScanningDecoder.createBarcodeMatrix(e);PDF417ScanningDecoder.adjustCodewordCount(e,t);let o=new Array,n=new Int32Array(e.getBarcodeRowCount()*e.getBarcodeColumnCount()),r=[],l=new Array;for(let c=0;c<e.getBarcodeRowCount();c++)for(let u=0;u<e.getBarcodeColumnCount();u++){let a=t[c][u+1].getValue(),d=c*e.getBarcodeColumnCount()+u;0===a.length?o.push(d):1===a.length?n[d]=a[0]:(l.push(d),r.push(a))}let c=new Array(r.length);for(let e=0;e<c.length;e++)c[e]=r[e];return PDF417ScanningDecoder.createDecoderResultFromAmbiguousValues(e.getBarcodeECLevel(),n,PDF417Common.toIntArray(o),PDF417Common.toIntArray(l),c)}static createDecoderResultFromAmbiguousValues(e,t,o,n,r){let l=new Int32Array(n.length),c=100;for(;c-- >0;){for(let e=0;e<l.length;e++)t[n[e]]=r[e][l[e]];try{return PDF417ScanningDecoder.decodeCodewords(t,e,o)}catch(e){if(!(e instanceof ChecksumException))throw e}if(0===l.length)throw ChecksumException.getChecksumInstance();for(let e=0;e<l.length;e++){if(l[e]<r[e].length-1){l[e]++;break}if(l[e]=0,e===l.length-1)throw ChecksumException.getChecksumInstance()}}throw ChecksumException.getChecksumInstance()}static createBarcodeMatrix(e){let t=Array.from({length:e.getBarcodeRowCount()},(()=>new Array(e.getBarcodeColumnCount()+2)));for(let e=0;e<t.length;e++)for(let o=0;o<t[e].length;o++)t[e][o]=new BarcodeValue;let o=0;for(let n of e.getDetectionResultColumns()){if(null!=n)for(let e of n.getCodewords())if(null!=e){let n=e.getRowNumber();if(n>=0){if(n>=t.length)continue;t[n][o].setValue(e.getValue())}}o++}return t}static isValidBarcodeColumn(e,t){return t>=0&&t<=e.getBarcodeColumnCount()+1}static getStartColumn(e,t,o,n){let r=n?1:-1,l=null;if(PDF417ScanningDecoder.isValidBarcodeColumn(e,t-r)&&(l=e.getDetectionResultColumn(t-r).getCodeword(o)),null!=l)return n?l.getEndX():l.getStartX();if(l=e.getDetectionResultColumn(t).getCodewordNearby(o),null!=l)return n?l.getStartX():l.getEndX();if(PDF417ScanningDecoder.isValidBarcodeColumn(e,t-r)&&(l=e.getDetectionResultColumn(t-r).getCodewordNearby(o)),null!=l)return n?l.getEndX():l.getStartX();let c=0;for(;PDF417ScanningDecoder.isValidBarcodeColumn(e,t-r);){t-=r;for(let o of e.getDetectionResultColumn(t).getCodewords())if(null!=o)return(n?o.getEndX():o.getStartX())+r*c*(o.getEndX()-o.getStartX());c++}return n?e.getBoundingBox().getMinX():e.getBoundingBox().getMaxX()}static detectCodeword(e,t,o,n,r,l,c,u){r=PDF417ScanningDecoder.adjustCodewordStartColumn(e,t,o,n,r,l);let a,d=PDF417ScanningDecoder.getModuleBitCount(e,t,o,n,r,l);if(null==d)return null;let i=MathUtils.sum(d);if(n)a=r+i;else{for(let e=0;e<d.length/2;e++){let t=d[e];d[e]=d[d.length-1-e],d[d.length-1-e]=t}a=r,r=a-i}if(!PDF417ScanningDecoder.checkCodewordSkew(i,c,u))return null;let g=PDF417CodewordDecoder.getDecodedValue(d),C=PDF417Common.getCodeword(g);return-1===C?null:new Codeword(r,a,PDF417ScanningDecoder.getCodewordBucketNumber(g),C)}static getModuleBitCount(e,t,o,n,r,l){let c=r,u=new Int32Array(8),a=0,d=n?1:-1,i=n;for(;(n?c<o:c>=t)&&a<u.length;)e.get(c,l)===i?(u[a]++,c+=d):(a++,i=!i);return a===u.length||c===(n?o:t)&&a===u.length-1?u:null}static getNumberOfECCodeWords(e){return 2<<e}static adjustCodewordStartColumn(e,t,o,n,r,l){let c=r,u=n?-1:1;for(let a=0;a<2;a++){for(;(n?c>=t:c<o)&&n===e.get(c,l);){if(Math.abs(r-c)>PDF417ScanningDecoder.CODEWORD_SKEW_SIZE)return r;c+=u}u=-u,n=!n}return c}static checkCodewordSkew(e,t,o){return t-PDF417ScanningDecoder.CODEWORD_SKEW_SIZE<=e&&e<=o+PDF417ScanningDecoder.CODEWORD_SKEW_SIZE}static decodeCodewords(e,t,o){if(0===e.length)throw FormatException.getFormatInstance();let n=1<<t+1,r=PDF417ScanningDecoder.correctErrors(e,o,n);PDF417ScanningDecoder.verifyCodewordCount(e,n);let l=DecodedBitStreamParser.decode(e,""+t);return l.setErrorsCorrected(r),l.setErasures(o.length),l}static correctErrors(e,t,o){if(null!=t&&t.length>o/2+PDF417ScanningDecoder.MAX_ERRORS||o<0||o>PDF417ScanningDecoder.MAX_EC_CODEWORDS)throw ChecksumException.getChecksumInstance();return PDF417ScanningDecoder.errorCorrection.decode(e,o,t)}static verifyCodewordCount(e,t){if(e.length<4)throw FormatException.getFormatInstance();let o=e[0];if(o>e.length)throw FormatException.getFormatInstance();if(0===o){if(!(t<e.length))throw FormatException.getFormatInstance();e[0]=e.length-t}}static getBitCountForCodeword(e){let t=new Int32Array(8),o=0,n=t.length-1;for(;!((1&e)!==o&&(o=1&e,n--,n<0));)t[n]++,e>>=1;return t}static getCodewordBucketNumber(e){return e instanceof Int32Array?this.getCodewordBucketNumber_Int32Array(e):this.getCodewordBucketNumber_number(e)}static getCodewordBucketNumber_number(e){return PDF417ScanningDecoder.getCodewordBucketNumber(PDF417ScanningDecoder.getBitCountForCodeword(e))}static getCodewordBucketNumber_Int32Array(e){return(e[0]-e[2]+e[4]-e[6]+9)%9}static toString(e){let t=new Formatter;for(let o=0;o<e.length;o++){t.format("Row %2d: ",o);for(let n=0;n<e[o].length;n++){let r=e[o][n];0===r.getValue().length?t.format("        ",null):t.format("%4d(%2d)",r.getValue()[0],r.getConfidence(r.getValue()[0]))}t.format("%n")}return t.toString()}}PDF417ScanningDecoder.CODEWORD_SKEW_SIZE=2,PDF417ScanningDecoder.MAX_ERRORS=3,PDF417ScanningDecoder.MAX_EC_CODEWORDS=512,PDF417ScanningDecoder.errorCorrection=new ErrorCorrection;
//# sourceMappingURL=/sm/e0aa48a9c71ce43da20cd4ae0e0c7d250f6dab9c1363adb7753792a097aa0105.map